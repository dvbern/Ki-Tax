<!--
  ~ Ki-Tax: System for the management of external childcare subsidies
  ~ Copyright (C) 2017 City of Bern Switzerland
  ~ This program is free software: you can redistribute it and/or modify
  ~ it under the terms of the GNU Affero General Public License as
  ~ published by the Free Software Foundation, either version 3 of the
  ~ License, or (at your option) any later version.
  ~ This program is distributed in the hope that it will be useful,
  ~ but WITHOUT ANY WARRANTY; without even the implied warranty of
  ~ MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
  ~ GNU Affero General Public License for more details.
  ~ You should have received a copy of the GNU Affero General Public License
  ~ along with this program. If not, see <http://www.gnu.org/licenses/>.
  -->

<div class="verfuegenView gesuchModul">
    <h1 class="access-for-all-title" data-translate="AFA_GESUCHSFORMULAR"></h1>
    <div class="row">
        <div class="col-md-12">
            <form role="form" name="vm.form" class="" novalidate unsaved-warning-form>

                <!-- Titel -->
                <div class="row marginTop40">
                    <div class="col-md-8">
                        <h3 class="ebeguH2" class="mainTitle">
                            {{vm.getKindName()}} / {{vm.getInstitutionName()}}
                        </h3>
                    </div>
                    <div class="col-md-4 text-right">
                        <h3 class="ebeguH2" aria-hidden class="mainTitle">
                            {{vm.getBetreuungNumber()}}
                        </h3>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <hr class="header"/>
                    </div>
                </div>

                <!-- Status -->
                <div class="row">
                    <div class="col-md-12">
                        <div class="betreuung-status verfuegenView ng-class:vm.getBetreuungsstatus();">
                            <div
                                ng-bind="vm.getBetreuungsstatus() | translate">
                            </div>
                            <span class="betreuung-bar"></span>
                        </div>
                    </div>
                </div>

                <!-- Tabelle -->
                <div class="row" ng-if="vm.showVerfuegungsDetails()">
                    <div class="col-md-12 table-responsive">
                        <table st-table="displayedCollection" st-safe-src="vm.getVerfuegungZeitabschnitte()"
                               class="table">
                            <thead>
                            <tr>
                                <td class="infotext"></td>
                                <td class="infotext"></td>
                                <td class="infotext">
                                    <dv-tooltip text="'EFFEKTIVE_BETREUUNG_HELP' | translate"></dv-tooltip>
                                </td>
                                <td class="infotext">
                                    <dv-tooltip text="'ANSPRUCH_HELP' | translate"></dv-tooltip>
                                </td>
                                <td class="infotext">
                                    <dv-tooltip text="'VERGUENSTIGT_HELP' | translate"></dv-tooltip>
                                </td>
                                <td class="infotext">
                                    <dv-tooltip text="'VOLLKOSTEN_HELP' | translate"></dv-tooltip>
                                </td>
                                <td class="infotext">
                                    <dv-tooltip text="'GUTSCHEIN_OHNE_BERUECKSICHTIGUNG_VOLLKOSTEN_HELP' | translate"></dv-tooltip>
                                </td>
                                <td class="infotext result">
                                    <dv-tooltip text="'GUTSCHEIN_OHNE_BERUECKSICHTIGUNG_MINIMALBEITRAG_HELP' | translate"></dv-tooltip>
                                </td>
                                <td class="infotext result">
                                    <dv-tooltip text="'MIN_ELTERNBEITRAG_HELP' | translate"></dv-tooltip>
                                </td>
                                <td class="infotext result">
                                    <dv-tooltip text="'VERGUENSTIGUNG_HELP' | translate"></dv-tooltip>
                                </td>
                            </tr>
                            <tr>
                                <th class="text-right datum" data-translate="BETREUUNG_VON"></th>
                                <th class="text-right datum" data-translate="BETREUUNG_BIS"></th>
                                <th class="text-right betrag" data-translate="EFFEKTIVE_BETREUUNG"></th>
                                <th class="text-right betrag" data-translate="ANSPRUCH"></th>
                                <th class="text-right betrag" data-translate="VERGUENSTIGT"></th>
                                <th class="text-right betrag" data-translate="VOLLKOSTEN"></th>
                                <th class="text-right betrag" data-translate="GUTSCHEIN_OHNE_BERUECKSICHTIGUNG_VOLLKOSTEN"></th>
                                <th class="text-right betrag result gutschein" data-translate="GUTSCHEIN_OHNE_BERUECKSICHTIGUNG_MINIMALBEITRAG"></th>
                                <th class="text-right betrag result" data-translate="MIN_ELTERNBEITRAG"></th>
                                <th class="text-right betrag result" data-translate="VERGUENSTIGUNG"></th>
                            </tr>
                            </thead>
                            <tbody ng-if="vm.getVerfuegungZeitabschnitte().length > 0">
                            <tr ng-repeat="verfuegungZeitabschnitt in displayedCollection">
                                <!-- Von -->
                                <td class="text-right"
                                    ng-bind="verfuegungZeitabschnitt.gueltigkeit.gueltigAb | amDateFormat : 'DD.MM.YYYY'"></td>
                                <!-- Bis -->
                                <td class="text-right"
                                    ng-bind="verfuegungZeitabschnitt.gueltigkeit.gueltigBis | amDateFormat : 'DD.MM.YYYY'"></td>
                                <!-- Effektives Betreuungspensum -->
                                <td class="text-right"><span
                                    ng-bind="verfuegungZeitabschnitt.betreuungspensum"></span>%</td>
                                <!-- Anspruchberechtigtes Pensum -->
                                <td class="text-right"><span
                                    ng-bind="verfuegungZeitabschnitt.anspruchberechtigtesPensum"></span>%</td>
                                <!-- Vergünstigtes Pensum -->
                                <td class="text-right"><span
                                    ng-bind="verfuegungZeitabschnitt.bgPensum"></span>%</td>
                                <!-- Kosten -->
                                <td class="text-right"
                                    ng-bind="verfuegungZeitabschnitt.vollkosten | currency : '' : 2"></td>
                                <!-- Gutschein gemäss Formel (Gutschein vor Beruecksichtigung Vollkosten) -->
                                <td class="text-right"
                                    ng-bind="verfuegungZeitabschnitt.verguenstigungOhneBeruecksichtigungVollkosten | currency : '' : 2"></td>
                                <!-- Gutschein (Gutschein vor Beruecksichtigung Minimalbeitrag) -->
                                <td class="text-right result gutschein"
                                    ng-bind="verfuegungZeitabschnitt.verguenstigungOhneBeruecksichtigungMinimalbeitrag | currency : '' : 2"></td>
                                <!-- Minimaler Elternbeitrag -->
                                <td class="text-right result"
                                    ng-bind="verfuegungZeitabschnitt.getMinimalerElternbeitragGekuerzt() | currency : '' : 2"></td>
                                <!-- An Kita überwiesen (Gutschein) -->
                                <td class="text-right result"
                                    ng-bind="verfuegungZeitabschnitt.verguenstigung | currency : '' : 2"></td>
                            </tr>
                            </tbody>
                            <tbody ng-if="vm.getVerfuegungZeitabschnitte().length === 0">
                            <tr>
                                <td colspan="10" class="empty-table">Zeitabschnitte noch nicht berechnet</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!--bemerkungen-->
                <div class="row marginTop20" dv-show-element
                     dv-show-allowed-roles="vm.TSRoleUtil.getGesuchstellerJugendamtRoles()"
                     dv-show-expression="vm.showVerfuegungsDetails()">
                    <div class="col-md-12 form-group">
                        <label class="md-no-float inlineHint" for="manuelle_notes"
                               data-translate="BEGRUENDUNG"></label>
                        <textarea md-no-autogrow class="form-control" rows="6" id="manuelle_notes"
                                  ng-model="vm.bemerkungen" ng-disabled="vm.isBemerkungenDisabled()"
                                  ng-attr-placeholder="{{'BEMERKUNGEN_PLACEHOLDER' | translate}}"
                                  maxlength="4000"></textarea>
                    </div>
                </div>

                <!--VerfuegungPDF anzeigen-->
                <div class="row marginTop20 text-left">
                    <div class="col-xs-12" ng-if="vm.showVerfuegungPdfLink()">
                        <button type="button" class="dv-btn btn-link link-underline"
                                ng-click="vm.openVerfuegungPDF()">
                            <i class="fa fa-file-text-o"></i>
                            <span data-translate="PDF_VERFUEGUNG_ANZEIGEN"></span>
                        </button>
                    </div>

                    <!--export for external programs-->
                    <div class="col-xs-12" dv-show-element
                         dv-show-allowed-roles="vm.TSRoleUtil.getAllRolesButGesuchsteller()"
                         dv-show-expression="vm.showExportLink()">
                        <a type="button" class="btn-link link-underline" ng-click="vm.openExport()" href="">
                            <i class="fa fa-file-text-o"></i>
                            <span data-translate="DOWNLOAD_EXPORT_FILE"></span>
                        </a>

                    </div>
                    <!--schemalinks-->
                    <div class="col-xs-12 marginTop10" dv-show-element
                         dv-show-allowed-roles="vm.TSRoleUtil.getAllRolesButGesuchsteller()"
                         dv-show-expression="vm.showSchemas && vm.showExportLink()">
                        <span class="marginRight10"> Schemas:</span>
                        <a ng-click="vm.exportJsonSchema()" href=""
                           class="btn-link link-underline"><span>json</span></a>
                        <a ng-click="vm.exportXmlSchema()" href="" title="to show please disable popupblocker"
                           class="btn-link link-underline"><span>xml</span></a>
                    </div>

                    <div class="col-xs-12" ng-if="vm.showNichtEintretenPdfLink()">
                        <button type="button" class="dv-btn btn-link link-underline"
                                ng-click="vm.openNichteintretenPDF()">
                            <i class="fa fa-file-text-o"></i>
                            <span data-translate="PDF_NICHT_EINTRETEN_ANZEIGEN"></span>
                        </button>
                    </div>
                </div>


                <div class="row marginTop20" ng-show="vm.isSameVerfuegungsdaten()">
                    <div class="col-md-12">
                        <div class="well well-status-warten">
                            <span data-translate="IDENTISCHE_BERECHNUNG"></span>
                        </div>
                    </div>
                </div>

                <!-- Navigation Buttons -->
                <div class="dv-navigation dv-navigation--verfuegen">
                    <dv-navigation dv-cancel="vm.cancel()" dv-next="false" dv-sub-step="2">
                    </dv-navigation>
                    <div class="dv-navigation-item"
                         dv-show-element
                         dv-show-allowed-roles="vm.TSRoleUtil.getAdministratorJugendamtRole()">
                        <dv-loading-button type="submit"
                                           button-click="vm.save()"
                                           ng-if="!vm.isSameVerfuegungsdaten() && vm.showVerfuegen()"
                                           class="dv-navigation-item">
                            <span class="uppercase" data-translate="VERFUEGEN"></span>
                        </dv-loading-button>
                        <dv-loading-button type="submit"
                                           button-click="vm.nichtEintreten()"
                                           ng-if="!vm.isSameVerfuegungsdaten() && vm.showVerfuegen() && vm.gesuchModelManager.isGesuch()"
                                           class="dv-navigation-item">
                            <span class="uppercase" data-translate="VERFUEGEN_NICHT_EINTRETEN"></span>
                        </dv-loading-button>
                        <div class="dv-navigation-item"
                             ng-show="!vm.isSameVerfuegungsdaten() && vm.showVerfuegen() && !vm.gesuchModelManager.isGesuch()">
                            <!--Mutation wird nicht akzeptiert -> schliessen ohne Verfuegung. Der Status ist passt meiner Meinung
                            nach nicht 100% aber im Moment passt der am besten. (siehe auch EBEGU-890) -->
                            <dv-loading-button type="submit"
                                               button-click="vm.schliessenOhneVerfuegen()"
                                               ng-if="!vm.disableAblehnen()">
                                <span class="uppercase" data-translate="VERFUEGEN_ABLEHNEN"></span>
                            </dv-loading-button>
                        </div>
                        <div class="dv-navigation-item"
                             ng-show="vm.showVerfuegen() && vm.isSameVerfuegungsdaten()">
                            <dv-loading-button type="submit"
                                               button-click="vm.schliessenOhneVerfuegen()">
                                <span class="uppercase" data-translate="VERFUEGEN_VERZICHTEN"></span>
                            </dv-loading-button>
                        </div>
                        <div class="dv-navigation-item"
                             ng-show="vm.showVerfuegen() && vm.isSameVerfuegungsdaten()">
                            <dv-loading-button type="submit" button-click="vm.save()">
                                <span class="uppercase" data-translate="TROTZDEM_VERFUEGEN"></span>
                            </dv-loading-button>
                        </div>
                    </div>
                </div>

            </form>
        </div>
    </div>
</div>
