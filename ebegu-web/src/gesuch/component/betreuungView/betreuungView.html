<!--
  ~ Ki-Tax: System for the management of external childcare subsidies
  ~ Copyright (C) 2017 City of Bern Switzerland
  ~ This program is free software: you can redistribute it and/or modify
  ~ it under the terms of the GNU Affero General Public License as
  ~ published by the Free Software Foundation, either version 3 of the
  ~ License, or (at your option) any later version.
  ~ This program is distributed in the hope that it will be useful,
  ~ but WITHOUT ANY WARRANTY; without even the implied warranty of
  ~ MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
  ~ GNU Affero General Public License for more details.
  ~ You should have received a copy of the GNU Affero General Public License
  ~ along with this program. If not, see <http://www.gnu.org/licenses/>.
  -->

<div class="betreuung-view gesuch-modul">
    <h1 class="access-for-all-title" data-translate="AFA_GESUCHSFORMULAR"></h1>

    <div class="row view-title">
        <div class="col-md-8">
            <h2>
                <!--eventuell nummer noch anders lesen per methode-->
                <span data-translate="BETREUUNGSANGEBOT_NUMBER"
                      data-translate-value-kindname="{{vm.getKindModel().kindJA.getFullName()}}"
                      data-translate-value-geschlecht="{{vm.getKindModel().kindJA.geschlecht | translate}}"
                      data-translate-value-geburtsdatum="{{vm.getKindModel().kindJA.geburtsdatum | amDateFormat : 'DD.MM.YYYY'}}"></span>
            </h2>
            <dv-bisher gs="vm.getErweiterteBetreuungGS()"
                       ja="vm.getErweiterteBetreuungJA()"
                       specific-bisher-text="'DURCH_GEMEINDE_ERFASST' | translate"
                       show-specific-bisher-text-if-bisher-none="true"></dv-bisher>
        </div>
        <div class="col-md-4 text-right">
            <h2 class="ebegu-h2" aria-hidden>
                {{vm.model.bgNummer}}
            </h2>
        </div>
    </div>
    <div class="row">
        <div class="col-md-12">
            <hr class="header"/>
        </div>
    </div>


    <div class="row margin-top-40">
        <div class="col-md-12">
            <form role="form" name="vm.form" class="" novalidate
                  unsaved-warning-form>

                <!-- Nur fuer Institutionen/Traegerschaften eingeblendet-->
                <div dv-show-element dv-show-allowed-roles="vm.TSRoleUtil.getTraegerschaftInstitutionRoles()">
                    <!--Fachstelle-->
                    <div ng-if="vm.getKindModel().hasPensumFachstelle()">
                        <div class="row">
                            <div class="col-sm-12 dv-input-container-medium form-group">
                                <label class="md-no-float" data-translate="FACHSTELLE"></label>
                                <input id="fachstelle_ID" type="text" name="fachstelle" ng-disabled="true"
                                       ng-value="vm.getKindModel().extractFachstelle().name | translate"
                                       class="form-control">
                                <div class="dv-error-messages"></div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-sm-12 dv-input-container-small form-group">
                                <label class="md-no-float" data-translate="BETREUUNGSPENSUM_FACHSTELLE"></label>
                                <input id="pensumFachstelle_ID" type="text" name="pensumFachstelle" ng-disabled="true"
                                       ng-value="vm.getKindModel().extractPensumFachstelle().pensum"
                                       class="form-control">
                                <div class="dv-error-messages"></div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-sm-6 dv-input-container-small form-group">
                                <label class="md-no-float" data-translate="VON"></label>
                                <input id="pensumFachstelleGueltigAb_ID" type="text" name="pensumFachstelleGueltigAb"
                                       ng-disabled="true"
                                       ng-value="vm.getKindModel().extractPensumFachstelle().gueltigkeit.gueltigAb | amDateFormat : 'DD.MM.YYYY'"
                                       class="form-control">
                                <div class="dv-error-messages"></div>
                            </div>
                            <div class="col-sm-6 dv-input-container-small form-group">
                                <label class="md-no-float" data-translate="BIS"></label>
                                <input id="pensumFachstelleGueltigBis_ID" type="text" name="pensumFachstelleGueltigBis"
                                       ng-disabled="true"
                                       ng-value="vm.getKindModel().extractPensumFachstelle().gueltigkeit.gueltigBis | amDateFormat : 'DD.MM.YYYY'"
                                       class="form-control">
                                <div class="dv-error-messages"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <fieldset>

                    <!--Betreuungsangebot (Mit diesem Wert filtern wir die Institutionen)-->
                    <div class="row" ng-disabled="!vm.enableBetreuungsangebotsTyp()">
                        <div class="col-sm-12 dv-input-container-medium">
                            <div class="form-group">
                                <label class="md-no-float"
                                       for="betreuungsangebot">
                                    <span data-translate="BETREUUNGSANGEBOT_WAEHLEN" class="required"></span>
                                </label>
                                <div class="dv-select-style">
                                    <select aria-describedby="betreuungsangebot-error" name="betreuungsangebot"
                                            id="betreuungsangebot"
                                            ng-model="vm.betreuungsangebot"
                                            class="form-control"
                                            ng-options="betreuungsangebot as betreuungsangebot.value for betreuungsangebot in vm.betreuungsangebotValues"
                                            ng-required="true"
                                            ng-disabled="!vm.isEnabled() || !vm.enableBetreuungsangebotsTyp()"
                                            ng-change="vm.changedAngebot()">
                                    </select>
                                    <dv-error-messages input-id="betreuungsangebot"
                                                       for="vm.form.betreuungsangebot.$error"></dv-error-messages>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Keine Detailangaben zur Anmeldung -->
                    <div class="row margin-bottom-20 margin-top-20" dv-show-element
                         dv-show-allowed-roles="vm.TSRoleUtil.getAdministratorOrAmtRole()"
                         dv-show-expression="vm.isTagesschule() && vm.gesuchModelManager.getGesuchsperiode().hasTagesschulenAnmeldung()">
                        <div class="col-xs-12 dv-input-container-question">
                            <div class="checkbox">
                                <md-checkbox ng-model="vm.getBetreuungModel().keineDetailinformationen"
                                             name="keineDetailinformationen"
                                             ng-change="vm.keineDetailAnmeldungClicked()"
                                             aria-label="{{'ANMELDUNG_KEINE_DETAILINFORMATIONEN'|translate}}"
                                             ng-disabled="!vm.isEnabled()">
                                    <span data-translate="ANMELDUNG_KEINE_DETAILINFORMATIONEN"></span>
                                </md-checkbox>
                            </div>
                        </div>
                    </div>

                    <!--vertrag radiogroup-->
                    <div class="row" ng-if="vm.isGesuchsteller() && !vm.isSchulamt()">
                        <div class="col-xs-12 dv-input-container-question">
                            <div class="form-group">
                                <md-radio-group class="radio"
                                                ng-model="vm.getBetreuungModel().vertrag"
                                                ng-change="vm.onChangeVertrag()"
                                                dv-suppress-form-submit-on-enter
                                                aria-label="{{vm.ariaLabel}}"
                                                ng-disabled="!vm.isEnabled()"
                                                ng-required="true">

                                    <md-radio-button ng-value="true"
                                                     aria-label="{{'VERTRAG'| translate}}"
                                                     class="element-ja"
                                                     aria-describedby="{{vm.ariaDescribedBy}}"
                                                     ng-required="true">
                                        <span data-translate="VERTRAG"></span>
                                    </md-radio-button>
                                    <md-radio-button ng-value="false"
                                                     aria-label="{{'KEIN_VERTRAG'| translate}}"
                                                     class="element-nein"
                                                     aria-describedby="{{vm.ariaDescribedBy}}"
                                                     ng-required="true">
                                        <span data-translate="KEIN_VERTRAG"></span>
                                    </md-radio-button>
                                </md-radio-group>
                            </div>
                        </div>
                    </div>

                    <!--provisorische Betreuung-->
                    <fieldset>
                        <div ng-if="vm.isProvisorischeBetreuung() && !vm.getBetreuungModel().keineDetailinformationen">

                            <dv-betreuung-input pensum-container="vm.getBetreuungspensum(0)"
                                                input-id="provPensum"
                                                is-disabled="!vm.isEnabled()"
                                                betreuungsangebot-typ="vm.betreuungsangebot.key">
                            </dv-betreuung-input>

                            <!--provisorische monatliche Betreuungskosten-->
                            <div class="row">
                                <div class="col-sm-12 dv-input-container-medium">
                                    <dv-input-container class="form-group">
                                        <label class="md-no-float"
                                               for="provMonatlicheBetreuungskosten">
                                            <span data-translate="GESCHAETZTE_MONATLICHE_BETREUUNGSKOSTEN"></span>
                                            <dv-tooltip input-id="provMonatlicheBetreuungskosten"
                                                        text="'GESCHAETZTE_MONATLICHE_BETREUUNGSKOSTEN_HELP' | translate"></dv-tooltip>
                                        </label>
                                        <div class="dv-input-container-medium-label">
                                            <input aria-describedby="provMonatlicheBetreuungskosten-error"
                                                   id="provMonatlicheBetreuungskosten" type="number"
                                                   name="provMonatlicheBetreuungskosten"
                                                   ng-model="vm.getBetreuungspensum(0).betreuungspensumJA.monatlicheBetreuungskosten"
                                                   dv-max-length class="form-control"
                                                   ng-pattern="vm.CONSTANTS.PATTERN_TWO_DECIMALS"
                                                   ng-required="true"
                                                   ng-disabled="!vm.isEnabled()"
                                                   ng-attr-placeholder="{{'BETRAG_PLACEHOLDER' | translate}}">
                                            <dv-error-messages input-id="provMonatlicheBetreuungskosten"
                                                               for="vm.form['provMonatlicheBetreuungskosten'].$error"></dv-error-messages>
                                        </div>

                                    </dv-input-container>
                                </div>
                            </div>
                        </div>
                    </fieldset>

                    <!--Institutionen-->
                    <div ng-if="vm.getBetreuungModel().vertrag">
                        <!--Institutionen, wenn editable ist oder der status falsche institution ist, als liste anzeigen-->
                        <div class="row"
                             ng-if="vm.showInstitutionenList()">
                            <div class="col-sm-12 dv-input-container-medium form-group">
                                <label class="md-no-float required" data-translate="INSTITUTION" for="institution">
                                </label>
                                <md-autocomplete flex
                                                 md-input-name="institution"
                                                 md-input-id="institution"
                                                 md-min-length="0"
                                                 md-no-cache="true"
                                                 md-delay="0"
                                                 class="form-control"
                                                 ng-attr-placeholder="{{'SUCHBEGRIFF_EINGEBEN' | translate}}"
                                                 md-select-on-focus="true"
                                                 md-selected-item="vm.instStamm"
                                                 md-match-case-insensitive="true"
                                                 md-menu-container-class="institution-autocomplete"
                                                 md-selected-item-change="vm.setSelectedInstitutionStammdaten()"
                                                 md-search-text="vm.searchQuery"
                                                 md-require-match="true"
                                                 md-items="item in vm.querySearch(vm.searchQuery)"
                                                 md-item-text="item.institution.name"
                                                 ng-required="true">
                                    <md-item-template>
                                        <span md-highlight-text="vm.searchQuery">
                                            {{item.getAutocompleteText()}}
                                        </span>
                                    </md-item-template>
                                </md-autocomplete>
                                <span ng-if="vm.form.institution.$touched">
                                    <dv-error-messages input-id="institution"
                                                       for="vm.form.institution.$error"></dv-error-messages>
                                </span>
                            </div>
                        </div>
                        <!-- Institiutionen wenn readonly als Textfeld anzeigen-->
                        <div class="row" ng-if="vm.showInstitutionenAsText()">
                            <div class="col-sm-12 dv-input-container-medium form-group">
                                <label class="md-no-float" data-translate="INSTITUTION" for="institution">
                                </label>
                                <input aria-describedby="institutioninput-error"
                                       name="institution"
                                       id="institutioninput"
                                       type="text"
                                       ng-model="vm.getInstitutionSD().institution.name"
                                       class="form-control"
                                       ng-required="true"
                                       ng-disabled="!vm.isEnabled()">
                                <dv-error-messages input-id="institutioninput" for="vm.form.institutioninput.$error"
                                                   class="error"></dv-error-messages>
                            </div>
                        </div>
                    </div>

                    <!--Kesb Platzierung-->
                    <div class="row"
                         dv-show-element
                         dv-show-allowed-roles="vm.TSRoleUtil.getAllRolesButTraegerschaftInstitution()"
                         dv-show-expression="!vm.isSchulamt()">
                        <div class="col-xs-12 dv-input-container-question">
                            <div class="checkbox">
                                <md-checkbox ng-model="vm.getErweiterteBetreuungJA().keineKesbPlatzierung"
                                             name="keineKesbPlatzierung"
                                             aria-label="{{'KEINE_KESB_PLATZIERUNG'|translate}}"
                                             dv-enable-element
                                             dv-enable-allowed-roles="vm.TSRoleUtil.getAdministratorJugendamtSchulamtGesuchstellerRoles()"
                                             dv-enable-expression="vm.enableErweiterteBeduerfnisse()">
                                    <span data-translate="KEINE_KESB_PLATZIERUNG"></span>
                                </md-checkbox>
                                <dv-bisher gs="vm.getErweiterteBetreuungGS().keineKesbPlatzierung"
                                           ja="vm.getErweiterteBetreuungJA().keineKesbPlatzierung"
                                           show-if-bisher-none="vm.isNotNullOrUndefined(vm.getErweiterteBetreuungGS())"></dv-bisher>
                            </div>
                        </div>
                    </div>

                    <!--erweiterte Beduerfnisse-->
                    <div class="row" ng-if="vm.showErweiterteBeduerfnisse() && !vm.isSchulamt()">
                        <div class="col-xs-12 dv-input-container-question">
                            <div class="checkbox">
                                <md-checkbox ng-model="vm.getErweiterteBetreuungJA().erweiterteBeduerfnisse"
                                             name="erweiterteBeduerfnisse"
                                             aria-label="{{'ERWEITERTE_BEDUERFNISSE'|translate}}"
                                             dv-enable-element
                                             dv-enable-allowed-roles="vm.TSRoleUtil.getAdministratorJugendamtSchulamtGesuchstellerRoles()"
                                             dv-enable-expression="vm.enableErweiterteBeduerfnisse()"
                                             ng-change="vm.changedBesondereBeduerfnisse()">
                                    <span data-translate="ERWEITERTE_BEDUERFNISSE"></span>
                                </md-checkbox>
                                <dv-bisher gs="vm.getErweiterteBetreuungGS().erweiterteBeduerfnisse"
                                           ja="vm.getErweiterteBetreuungJA().erweiterteBeduerfnisse"
                                           specific-bisher-text="vm.getTextFachstelleKorrekturJA()"
                                           show-if-bisher-none="vm.isNotNullOrUndefined(vm.getErweiterteBetreuungGS())"></dv-bisher>
                            </div>
                        </div>
                    </div>

                    <!--Fachstelle erweiterte Beduerfnisse-->
                    <div ng-if="vm.isFachstelleRequired()">
                        <div class="row">
                            <div class="col-sm-12 dv-input-container-medium form-group">
                                <label class="md-no-float required" data-translate="FACHSTELLE" for="fachstelle">
                                </label>
                                <div class="dv-select-style">
                                    <select aria-describedby="fachstelle-error"
                                            name="fachstelle"
                                            id="fachstelle"
                                            ng-model="vm.fachstelleId"
                                            class="form-control"
                                            ng-options="fachstelle.id as fachstelle.name | translate for fachstelle in vm.getFachstellenList() | orderBy: 'name'"
                                            ng-required="vm.isFachstelleRequired()"
                                            ng-disabled="!vm.enableErweiterteBeduerfnisse()"
                                            ng-change="vm.setSelectedFachsstelle()">
                                    </select>
                                    <dv-bisher gs="vm.getErweiterteBetreuungGS().fachstelle.name"
                                               ja="vm.getErweiterteBetreuungJA().fachstelle.name"
                                               show-if-bisher-none="vm.isNotNullOrUndefined(vm.getErweiterteBetreuungGS())"></dv-bisher>
                                    <dv-error-messages input-id="fachstelle" for="vm.form.fachstelle.$error"
                                                       class="error"></dv-error-messages>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!--Bestätigung Ausserordentlicher Betreuungsaufwand-->
                    <div class="row"
                         dv-show-element
                         dv-show-allowed-roles="vm.TSRoleUtil.getAllRolesButGesuchsteller()"
                         dv-show-expression="vm.isFachstelleRequired()">
                        <div class="col-xs-12 dv-input-container-question">
                            <div class="checkbox">
                                <md-checkbox ng-model="vm.getErweiterteBetreuungJA().erweiterteBeduerfnisseBestaetigt"
                                             name="erweiterteBeduerfnisseBestaetigt"
                                             aria-label="vm.getErweiterteBeduerfnisseBestaetigtLabel()"
                                             ng-disabled="!vm.isBestaetigungBesondereBeduerfnisseEnabled()">
                                    <span>{{vm.getErweiterteBeduerfnisseBestaetigtLabel()}}</span>
                                </md-checkbox>
                            </div>
                        </div>
                    </div>

                    <!--Betreuung in Gemeinde-->
                    <div class="row"
                         dv-show-element
                         dv-show-allowed-roles="vm.TSRoleUtil.getAllRolesButGesuchsteller()"
                         dv-show-expression="vm.isBetreuungInGemeindeRequired()">
                        <div class="col-xs-12 dv-input-container-question">
                            <div class="checkbox">
                                <md-checkbox ng-model="vm.getErweiterteBetreuungJA().betreuungInGemeinde"
                                             name="betreuungInGemeinde"
                                             aria-label="{{vm.getBetreuungInGemeindeLabel()}}"
                                             dv-enable-element
                                             dv-enable-allowed-roles="vm.TSRoleUtil.getTraegerschaftInstitutionRoles()"
                                             dv-enable-expression="vm.isBetreuungsstatusWarten()">
                                    <span>{{vm.getBetreuungInGemeindeLabel()}}</span>
                                </md-checkbox>
                            </div>
                        </div>
                    </div>

                </fieldset>

                <fieldset ng-disabled="vm.isGesuchReadonly() && !vm.isMutationsmeldungStatus">
                    <!--Diese Felder werden fuer Betreuungsangebottyp TAGESSCHULE ausgeblendet. Fuer alle anderen eingeblendet-->
                    <!--Nur Institutionen duerfen neue Pensen eintragen. Bei anderen Rollen werden nur die existierenden Pensen angezeigt-->
                    <div class="margin-top-20" ng-if="!vm.isSchulamt()">

                        <div class="row" dv-show-element
                             dv-show-allowed-roles="vm.TSRoleUtil.getTraegerschaftInstitutionOnlyRoles()"
                             dv-show-expression="vm.showExistingBetreuungsmitteilungInfoBox()">
                            <div class="col-md-6">
                                <div class="box-existing-mutationsmeldung">
                                    <i class="fa fa-exclamation" aria-hidden="true"></i>
                                    <a href="" ng-click="vm.openExistingBetreuungsmitteilung()"
                                       data-translate="EXISTING_MUTATIONSMELDUNG"
                                       data-translate-value-datum-mutationsmeldung="{{vm.getDatumLastBetreuungsmitteilung()}}"
                                       data-translate-value-time-mutationsmeldung="{{vm.getTimeLastBetreuungsmitteilung()}}"></a>
                                </div>
                            </div>
                        </div>

                        <div ng-if="!vm.isProvisorischeBetreuung()">
                            <fieldset dv-enable-element
                                      dv-enable-allowed-roles="vm.TSRoleUtil.getTraegerschaftInstitutionRoles()"
                                      dv-enable-expression="vm.isPensumEditable()">

                                <p class="inline-hint" data-translate="BETREUUNG_HINT_UNTERMONATLICH"
                                        ng-show="vm.getBetreuungspensen().length > 0"></p>

                                <!--Betreuungspensen-->
                                <div ng-repeat="betpen in vm.getBetreuungspensen()">
                                    <!--Betreuungspensum-->
                                    <dv-betreuung-input pensum-container="vm.getBetreuungspensum($index)"
                                                        input-id="betreuungspensum-{{$index}}"
                                                        betreuungsangebot-typ="vm.getBetreuungModel().getAngebotTyp()"
                                                        is-disabled="!vm.isPensumEditable()">
                                    </dv-betreuung-input>
                                    <!--Monatliche Betreuungskosten-->
                                    <div class="row">
                                        <div class="col-sm-12 dv-input-container-medium">
                                            <dv-input-container class="form-group">
                                                <label class="md-no-float"
                                                       for="monatlicheBetreuungskosten-{{$index}}">
                                                    <span data-translate="MONATLICHE_BETREUUNGSKOSTEN"></span>
                                                    <dv-tooltip input-id="monatlicheBetreuungskosten-{{$index}}"
                                                                text="'MONATLICHE_BETREUUNGSKOSTEN_HELP' | translate"></dv-tooltip>
                                                </label>
                                                <div class="dv-input-container-medium-label">
                                                    <input
                                                        aria-describedby="monatlicheBetreuungskosten-{{$index}}-error"
                                                        id="monatlicheBetreuungskosten-{{$index}}" type="number"
                                                        name="monatlicheBetreuungskosten-{{$index}}"
                                                        ng-model="vm.getBetreuungspensum($index).betreuungspensumJA.monatlicheBetreuungskosten"
                                                        dv-max-length class="form-control"
                                                        ng-pattern="vm.CONSTANTS.PATTERN_TWO_DECIMALS"
                                                        ng-required="true"
                                                        ng-attr-placeholder="{{'BETRAG_PLACEHOLDER' | translate}}">
                                                    <dv-error-messages input-id="monatlicheBetreuungskosten-{{$index}}"
                                                                       for="vm.form['monatlicheBetreuungskosten-' + $index].$error"></dv-error-messages>
                                                </div>

                                            </dv-input-container>
                                        </div>
                                    </div>

                                    <div ng-if="vm.isMahlzeitenverguenstigungActive()">
                                        <div class="row">
                                            <!-- monatlicheHauptmahlzeiten -->
                                            <div class="col-sm-12 dv-input-container-small">
                                                <div class="form-group">
                                                    <dv-input-container class="form-group">
                                                        <label class="md-no-float"
                                                               for="monatlicheHauptmahlzeiten-{{$index}}">
                                                            <span data-translate="MONATLICHE_HAUPTMAHLZEITEN"></span>
                                                            <dv-tooltip input-id="monatlicheHauptmahlzeiten-tooltip-{{$index}}"
                                                                        text="'MONATLICHE_HAUPTMAHLZEITEN_HELP' | translate"></dv-tooltip>
                                                        </label>
                                                        <div class="dv-input-container-small" style="padding-right:32px;">
                                                            <input aria-describedby="monatlicheHauptmahlzeiten-{{$index}}-error"
                                                                   id="monatlicheHauptmahlzeiten-{{$index}}"
                                                                   type="number" min="0" step="1"
                                                                   name="monatlicheHauptmahlzeiten-{{$index}}"
                                                                   ng-model="vm.getBetreuungspensum($index).betreuungspensumJA.monatlicheHauptmahlzeiten"
                                                                   class="form-control"
                                                                   ng-required="true">
                                                            <dv-error-messages input-id="monatlicheHauptmahlzeiten-{{$index}}"
                                                                               for="vm.form['monatlicheHauptmahlzeiten-' + $index].$error"></dv-error-messages>
                                                        </div>
                                                    </dv-input-container>
                                                </div>
                                            </div>

                                            <!-- monatlicheNebenmahlzeiten -->
                                            <div class="col-sm-12 dv-input-container-small">
                                                <div class="form-group">
                                                    <dv-input-container class="form-group">
                                                        <label class="md-no-float"
                                                               for="monatlicheNebenmahlzeiten-{{$index}}">
                                                            <span data-translate="MONATLICHE_NEBENMAHLZEITEN"></span>
                                                            <dv-tooltip input-id="monatlicheNebenmahlzeiten-tooltip-{{$index}}"
                                                                        text="'MONATLICHE_NEBENMAHLZEITEN_HELP' | translate"></dv-tooltip>
                                                        </label>
                                                        <div class="dv-input-container-small" style="padding-right:32px;">
                                                            <input aria-describedby="monatlicheNebenmahlzeiten-{{$index}}-error"
                                                                   id="monatlicheNebenmahlzeiten-{{$index}}"
                                                                   type="number" min="0" step="1"
                                                                   name="monatlicheNebenmahlzeiten-{{$index}}"
                                                                   ng-model="vm.getBetreuungspensum($index).betreuungspensumJA.monatlicheNebenmahlzeiten"
                                                                   class="form-control"
                                                                   ng-required="true">
                                                            <dv-error-messages input-id="monatlicheNebenmahlzeiten-{{$index}}"
                                                                               for="vm.form['monatlicheNebenmahlzeiten-' + $index].$error"></dv-error-messages>
                                                        </div>
                                                    </dv-input-container>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <!-- tarif Hauptmhalzeiten -->
                                            <div class="col-sm-12 dv-input-container-small">
                                                <div class="form-group">
                                                    <dv-input-container class="form-group">
                                                        <label class="md-no-float"
                                                               for="tarifProHauptmahlzeit-{{$index}}">
                                                            <span data-translate="TARIF_PRO_HAUPTMAHLZEIT"></span>
                                                            <dv-tooltip input-id="tarifProHauptmahlzeit-tooltip-{{$index}}"
                                                                        text="'TARIF_PRO_HAUPTMAHLZEIT_HELP' | translate"></dv-tooltip>
                                                        </label>
                                                        <div class="dv-input-container-small" style="padding-right:32px;">
                                                            <input aria-describedby="tarifProHauptmahlzeit-{{$index}}-error"
                                                                   id="tarifProHauptmahlzeit-{{$index}}"
                                                                   type="number" min="0" step="0.05"
                                                                   ng-pattern="vm.CONSTANTS.PATTERN_TWO_DECIMALS"
                                                                   name="tarifProHauptmahlzeit-{{$index}}"
                                                                   ng-model="vm.getBetreuungspensum($index).betreuungspensumJA.tarifProHauptmahlzeit"
                                                                   class="form-control"
                                                                   ng-required="true">
                                                            <dv-error-messages input-id="tarifProHauptmahlzeit-{{$index}}"
                                                                               for="vm.form['tarifProHauptmahlzeit-' + $index].$error"></dv-error-messages>
                                                        </div>
                                                    </dv-input-container>
                                                </div>
                                            </div>
                                            <!-- tarif Nebenmahlzeiten -->
                                            <div class="col-sm-12 dv-input-container-small">
                                                <div class="form-group">
                                                    <dv-input-container class="form-group">
                                                        <label class="md-no-float"
                                                               for="tarifProNebenmahlzeit-{{$index}}">
                                                            <span data-translate="TARIF_PRO_NEBENMAHLZEIT"></span>
                                                            <dv-tooltip input-id="tarifProNebenmahlzeit-tooltip-{{$index}}"
                                                                        text="'TARIF_PRO_NEBENMAHLZEIT_HELP' | translate"></dv-tooltip>
                                                        </label>
                                                        <div class="dv-input-container-small" style="padding-right:32px;">
                                                            <input aria-describedby="tarifProNebenmahlzeit-{{$index}}-error"
                                                                   id="tarifProNebenmahlzeit-{{$index}}"
                                                                   type="number" min="0" step="0.05"
                                                                   ng-pattern="vm.CONSTANTS.PATTERN_TWO_DECIMALS"
                                                                   name="tarifProNebenmahlzeit-{{$index}}"
                                                                   ng-model="vm.getBetreuungspensum($index).betreuungspensumJA.tarifProNebenmahlzeit"
                                                                   class="form-control"
                                                                   ng-required="true">
                                                            <dv-error-messages input-id="tarifProNebenmahlzeit-{{$index}}"
                                                                               for="vm.form['tarifProNebenmahlzeit-' + $index].$error"></dv-error-messages>
                                                        </div>
                                                    </dv-input-container>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- gueltig ab / gueltig bis -->
                                    <div class="row">
                                        <div class="col-sm-12 dv-input-container-small">
                                            <dv-input-container class="form-group">
                                                <label class="md-no-float"
                                                       data-translate="VON"
                                                       for="datumAb-{{$index}}">
                                                </label>
                                                <dv-datepicker input-id="datumAb-{{$index}}" name="datumAb-{{$index}}"
                                                               class="input-element"
                                                               ng-model="vm.getBetreuungspensum($index).betreuungspensumJA.gueltigkeit.gueltigAb"
                                                               ng-required="true"
                                                               ng-attr-placeholder="{{'DATE_PLACEHOLDER' | translate}}">
                                                </dv-datepicker>
                                                <dv-error-messages input-id="datumAb-{{$index}}"
                                                                   for="vm.form['datumAb-' + $index].$error"></dv-error-messages>
                                            </dv-input-container>
                                        </div>

                                        <div class="col-sm-12 dv-input-container-small">
                                            <dv-input-container class="form-group">
                                                <label class="md-no-float"
                                                       data-translate="BIS"
                                                       for="datumBis-{{$index}}">
                                                </label>
                                                <dv-datepicker input-id="datumBis-{{$index}}" name="datumBis-{{$index}}"
                                                               class="input-element"
                                                               ng-model="vm.getBetreuungspensum($index).betreuungspensumJA.gueltigkeit.gueltigBis"
                                                               ng-required="false"
                                                               ng-attr-placeholder="{{'DATE_PLACEHOLDER' | translate}}">
                                                </dv-datepicker>
                                                <dv-error-messages input-id="datumBis-{{$index}}"
                                                                   for="vm.form['datumBis-' + $index].$error"></dv-error-messages>
                                            </dv-input-container>
                                        </div>
                                    </div>

                                    <betreuung-override-warning
                                        ng-if="vm.showOverrideWarning(vm.getBetreuungspensum($index))"
                                        [betreuungspensum]="vm.getBetreuungspensum($index).betreuungspensumJA.pensum"
                                        [betreuungskosten]="vm.getBetreuungspensum($index).betreuungspensumJA.monatlicheBetreuungskosten"
                                        [gueltig-ab]="vm.getBetreuungspensum($index).betreuungspensumJA.gueltigkeit.gueltigAb">
                                    </betreuung-override-warning>

                                    <!--Betreuungspensum entfernen. Wird nur angezeigt wenn status=AUSSTEHEND und es mehrere Betreuungspensen gibt und role=institution-->
                                    <div class="row margin-bottom-60 dv-input-container-medium" dv-show-element
                                         dv-show-allowed-roles="vm.TSRoleUtil.getTraegerschaftInstitutionRoles()"
                                         dv-show-expression="($index > 0) || (vm.getBetreuungspensen().length > 1)">
                                        <div class="col-md-12">
                                            <dv-loading-button type="button"
                                                               button-click="vm.removeBetreuungspensum(betpen)"
                                                               button-class="dv-btn-operation"
                                                               button-disabled="!vm.isPensumEditable()">
                                                <i class="fa fa-lg fa-trash-o"
                                                   title="{{'BETREUUNGSPENSUM_DELETE' | translate}}"
                                                   aria-label="{{'BETREUUNGSPENSUM_DELETE' | translate}}"></i>
                                                <span data-translate="BETREUUNGSPENSUM_ENTFERNEN_INDEX"
                                                      data-translate-value-betreuungspensumnumber="{{$index + 1}}"></span>
                                            </dv-loading-button>
                                            <hr class="header"/>
                                        </div>
                                    </div>
                                </div>

                                <!--Neues Betreuungspensum hinzufuegen-->
                                <div class="row" dv-show-element
                                     dv-show-allowed-roles="vm.TSRoleUtil.getTraegerschaftInstitutionRoles()"
                                     dv-show-expression="vm.isPensumEditable()">
                                    <div class="col-md-12">
                                        <dv-loading-button type="button" button-click="vm.createBetreuungspensum()"
                                                           dv-enable-element
                                                           dv-enable-allowed-roles="vm.TSRoleUtil.getTraegerschaftInstitutionRoles()"
                                                           dv-enable-expression="vm.isEnabled()"
                                                           button-class="dv-btn-operation">
                                            <i class="fa fa-lg fa-plus-circle"></i>
                                            <span data-translate="BETREUUNGSPENSUM_ERFASSEN"></span>
                                        </dv-loading-button>
                                    </div>
                                </div>

                                <!--grund Ablehnung-->
                                <div class="row margin-top-20" dv-show-element
                                     dv-show-allowed-roles="vm.TSRoleUtil.getTraegerschaftInstitutionRoles()">
                                    <div class="col-md-12 dv-input-container-medium">
                                        <dv-input-container class="form-group">
                                            <label class="md-no-float inline-hint" for="grundAblehnung"
                                                   data-translate="GRUND_ABLEHNUNG"></label>
                                            <textarea md-no-autogrow class="form-control" rows="6" id="grundAblehnung"
                                                      ng-model="vm.getBetreuungModel().grundAblehnung"
                                                      ng-disabled="!vm.isBetreuungsstatusWarten() || vm.isSavingData"
                                                      maxlength="4000">
                                        </textarea>
                                        </dv-input-container>
                                    </div>
                                </div>
                                <!-- Bestätigung Korrekte Kostenangabe -->
                                <div class="row"
                                     dv-show-element
                                     dv-show-allowed-roles="vm.TSRoleUtil.getTraegerschaftInstitutionRoles()"
                                     dv-show-expression="vm.isBetreuungsstatusWarten()">
                                    <div class="col-xs-12 dv-input-container-question">
                                        <div class="checkbox-bestaetigung">
                                            <md-checkbox ng-model="vm.korrekteKostenBestaetigung"
                                                         name="korrekteKostenBestaetigung"
                                                         aria-label="{{'KORREKTE_KOSTEN_BESTAETIGUNG_1'|translate}}"
                                                         ng-required="vm.isBestaetigenClicked">
                                                <span data-translate="KORREKTE_KOSTEN_BESTAETIGUNG_1"></span>
                                            </md-checkbox>
                                            <div class="dv-error-messages"
                                                 ng-if="vm.isBestaetigenClicked && !vm.korrekteKostenBestaetigung">
                                                <div ng-messages="vm.form.korrekteKostenBestaetigung.$error"
                                                     class="error">
                                                    <div ng-message="required"
                                                         data-translate="KORREKTE_KOSTEN_BESTAETIGUNG_ERROR"
                                                         for="vm.form.korrekteKostenBestaetigung.$error"
                                                         role="alert"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-xs-12">
                                        <ul>
                                            <li>{{'KORREKTE_KOSTEN_BESTAETIGUNG_2' | translate}}</li>
                                            <li>{{'KORREKTE_KOSTEN_BESTAETIGUNG_3' | translate}}</li>
                                        </ul>
                                    </div>
                                </div>
                            </fieldset>
                        </div>


                        <!-- Status texts -->
                        <div class="well well-status-warten" ng-if="vm.isBetreuungsstatusWarten() && !vm.isSavingData">
                            <i class="fa fa-hourglass" aria-hidden="true"></i>
                            <span data-translate="BETREUUNG_WARTEN_TEXT"></span>
                        </div>

                        <div class="well well-status-abgewiesen"
                             ng-if="vm.isBetreuungsstatusAbgewiesen() && !vm.isSavingData">
                            <i class="fa fa-times" aria-hidden="true"></i>
                            <span data-translate="BETREUUNG_ABGEWIESEN_TEXT"
                                  data-translate-value-grund="{{vm.getBetreuungModel().grundAblehnung}}"
                                  data-translate-value-date="{{vm.getBetreuungModel().datumAblehnung  | amDateFormat : 'DD.MM.YYYY'}}">
                            </span>
                        </div>
                        <div class="row">
                            <div class="col-md-12"
                                 ng-if="vm.isBetreuungsstatusBestaetigt() && !vm.isSavingData">
                                <div class=" well well-status-bestaetigt">
                                    <i class="fa fa-check" aria-hidden="true"></i>
                                    <span data-translate="BETREUUNG_BESTAETIGT_TEXT"
                                          data-translate-value-date="{{vm.getBetreuungModel().datumBestaetigung  | amDateFormat : 'DD.MM.YYYY'}}"></span>
                                </div>
                            </div>
                        </div>
                        <div class="well well-status-bestaetigt"
                             ng-if="vm.isBetreuungsstatusNichtEingetreten() && !vm.isSavingData">
                            <i class="fa fa-check" aria-hidden="true"></i>
                            <span data-translate="BETREUUNG_NICHT_EINGETRETEN_TEXT"
                                  data-translate-value-date="{{vm.getBetreuungModel().datumBestaetigung  | amDateFormat : 'DD.MM.YYYY'}}"></span>
                        </div>
                        <div class="well well-status-bestaetigt" ng-if="vm.isStorniert() && !vm.isSavingData">
                            <i class="fa fa-exclamation" aria-hidden="true"></i>
                            <span data-translate="BETREUUNG_STORNIERT_TEXT"></span>
                        </div>

                        <!--falsche Angaben-->
                        <div class="row" dv-show-element
                             dv-show-allowed-roles="vm.TSRoleUtil.getGesuchstellerJugendamtSchulamtRoles()"
                             dv-show-expression="vm.showFalscheAngaben()">
                            <div class="col-md-12">
                                <a href="" ng-click="vm.platzAnfordern()"
                                   data-translate="FALSCHE_ANGABEN"></a>
                            </div>
                        </div>

                        <!--Angabe korrigieren-->
                        <div class="row" dv-show-element
                             dv-show-allowed-roles="vm.TSRoleUtil.getGesuchstellerJugendamtSchulamtRoles()"
                             dv-show-expression="vm.showAngabenKorrigieren()">
                            <div class="col-md-12">
                                <a href="" ng-click="vm.platzAnfordern()"
                                   data-translate="ANGABEN_KORRIGIEREN"></a>
                            </div>
                        </div>

                        <!--Hint-->
                        <div ng-if="vm.isProvisorischeBetreuung()">
                            <p class="inline-hint margin-top-20" data-translate="BETREUUNGSPENSUM_HINT2"
                               dv-show-element dv-show-allowed-roles="vm.TSRoleUtil.getGesuchstellerRoles()"
                               dv-show-expression="!vm.isSchulamt()"></p>
                        </div>

                    </div>
                </fieldset>

                <!-- Tagesschule -->
                <div ng-if="vm.displayModuleTagesschule()">
                    <betreuung-tagesschule-view betreuung="vm.getBetreuungModel()" form="vm.form"
                                                on-save="vm.anmeldenSchulamt()"
                                                anmeldung-schulamt-uebernehmen="vm.anmeldungSchulamtUebernehmen(isScolaris)"
                                                anmeldung-schulamt-ablehnen="vm.anmeldungSchulamtAblehnen()"
                                                anmeldung-schulamt-falsche-institution="vm.anmeldungSchulamtFalscheInstitution()"
                                                cancel="vm.cancel()">
                    </betreuung-tagesschule-view>
                </div>

                <!-- Ferieninsel -->
                <div ng-if="vm.isFerieninsel()">
                    <betreuung-ferieninsel-view betreuung="vm.getBetreuungModel()" form="vm.form"
                                                on-save="vm.anmeldenSchulamt()"
                                                anmeldung-schulamt-uebernehmen="vm.anmeldungSchulamtUebernehmen(isScolaris)"
                                                anmeldung-schulamt-ablehnen="vm.anmeldungSchulamtAblehnen()"
                                                anmeldung-schulamt-falsche-institution="vm.anmeldungSchulamtFalscheInstitution()"
                                                cancel="vm.cancel()">
                    </betreuung-ferieninsel-view>
                </div>

                <!--Buttons-->
                <!--Hier wird die Direktive dv-navigation nicht benutzt. Grund dafuer ist, dass die Logik in diesem Fall sehr kompliziert ist.
                    wenn wir die Direktive benutzen wollen muessen wir viel anpassen, daher lohnt es sich die Buttons direkt zu erstellen-->
                <!-- todo verbessern. Es muss fuer alle Angebottypen geprueft werden ob die Buttons hier oder in den individuellen Component implementiert sind-->
                <div class="dv-navigation dv-navigation-flex" ng-if="vm.displayGlobalNavigationButtons()">
                    <!--Die Order der Knoepfe soll im HTML so sein, dass der weiter Knopf als erster im Form ist, dies wird dann fuer die darstelltung
                    mit Flexlayout wieder korrigiert. Grund ist, dass beim druecken von Enter in einem input Feld automaitisch der erste submit button triggered wird-->
                    <span dv-show-element
                          dv-show-allowed-roles="vm.TSRoleUtil.getGesuchstellerJugendamtSchulamtRoles()"
                          dv-show-expression="vm.isTagesschule() && !vm.tageschuleSaveDisabled()">

                        <dv-loading-button button-click="vm.saveSchulamt()" type="submit"
                                           button-class="save">
                            <span class="uppercase" data-translate="SPEICHERN"></span>
                        </dv-loading-button>
                    </span>

                    <span dv-show-element
                          dv-show-allowed-roles="vm.TSRoleUtil.getTraegerschaftInstitutionRoles()"
                          dv-show-expression="vm.isMutationsmeldungAllowed() && !vm.isMutationsmeldungStatus">
                        <dv-loading-button button-click="vm.gotoBetreuungAbweichungen()"
                                           aria-label="{{'ABWEICHUNGEN_MELDEN' | translate}}">
                            <span class="uppercase" data-translate="ABWEICHUNGEN_MELDEN"></span>
                        </dv-loading-button>
                    </span>

                    <!--Institution Buttons-->
                    <span dv-show-element
                          dv-show-allowed-roles="vm.TSRoleUtil.getTraegerschaftInstitutionRoles()"
                          dv-show-expression="vm.isMutationsmeldungAllowed()">

                        <dv-loading-button button-click="vm.mutationsmeldungErstellen()"
                                           ng-if="!vm.isMutationsmeldungStatus"
                                           aria-label="{{MUTATIONSMELDUNG_ERSTELLEN | translate}}">
                            <span class="uppercase" data-translate="MUTATIONSMELDUNG_ERSTELLEN"></span>
                        </dv-loading-button>
                        <dv-loading-button button-click="vm.mutationsmeldungSenden()"
                                           ng-if="vm.isMutationsmeldungStatus"
                                           aria-label="{{MUTATIONSMELDUNG_SENDEN | translate}}">
                            <span class="uppercase" data-translate="MUTATIONSMELDUNG_SENDEN"></span>
                        </dv-loading-button>
                    </span>

                    <span dv-show-element
                          dv-show-allowed-roles="vm.TSRoleUtil.getTraegerschaftInstitutionRoles()"
                          dv-show-expression="vm.isBetreuungsstatusWarten()">

                        <span ng-if="vm.isFromMutation()">
                            <dv-loading-button button-click="vm.stornieren()"
                                               aria-label="{{'STORNIEREN' | translate}}">
                                <span class="uppercase" data-translate="STORNIEREN"></span>
                            </dv-loading-button>
                        </span>

                        <span>
                            <dv-loading-button button-click="vm.platzBestaetigen()" type="submit"
                                               aria-label="{{'PLATZ_BESTAETIGEN' | translate}}">
                                <span class="uppercase" data-translate="PLATZ_BESTAETIGEN"></span>
                            </dv-loading-button>
                        </span>

                        <span ng-if="!vm.isFromMutation()">
                            <dv-loading-button button-click="vm.platzAbweisen()" type="submit"
                                               aria-label="{{'ABWEISEN' | translate}}">
                                <span class="uppercase" data-translate="ABWEISEN"></span>
                            </dv-loading-button>
                        </span>

                    </span>

                    <!--Platz anfordern-->
                    <span dv-show-element
                          dv-show-allowed-roles="vm.TSRoleUtil.getGesuchstellerJugendamtSchulamtRoles()"
                          dv-show-expression="vm.isBetreuungsstatusAusstehendOrUnbekannteInstitution() && !vm.isProvisorischeBetreuung()">
                        <dv-loading-button button-click="vm.platzAnfordern()" type="submit">
                            <span class="uppercase" data-translate="PLATZBESTAETIGUNG_ANFORDERN"></span>
                        </dv-loading-button>
                    </span>

                    <!-- Save -->
                    <span dv-show-element
                          dv-show-allowed-roles="vm.TSRoleUtil.getAdministratorJugendamtSchulamtGesuchstellerRoles()"
                          dv-show-expression="(vm.enableErweiterteBeduerfnisse() && !vm.isBetreuungsstatusAusstehendOrUnbekannteInstitution())">
                        <dv-loading-button button-click="vm.saveBetreuung()" type="submit">
                            <span class="uppercase" data-translate="SPEICHERN"></span>
                        </dv-loading-button>
                    </span>

                    <!-- Save provisorische Berechnung-->
                    <span dv-show-element
                          dv-show-allowed-roles="vm.TSRoleUtil.getGesuchstellerRoles()"
                          dv-show-expression="vm.isProvisorischeBetreuung() && vm.isEnabled()">
                        <dv-loading-button button-click="vm.saveProvisorischeBetreuung()" type="submit">
                            <span class="uppercase" data-translate="SPEICHERN"></span>
                        </dv-loading-button>
                    </span>

                    <!-- Abbrechen -->
                    <span>
                        <dv-loading-button button-click="vm.cancel()" button-class="cancel-button"
                                           type="reset">
                            <span class="uppercase" data-translate="ABBRECHEN"></span>
                        </dv-loading-button>
                    </span>
                </div>
            </form>
        </div>
    </div>
</div>
