<!--
  ~ Copyright (C) 2018 DV Bern AG, Switzerland
  ~
  ~ This program is free software: you can redistribute it and/or modify
  ~ it under the terms of the GNU Affero General Public License as
  ~ published by the Free Software Foundation, either version 3 of the
  ~ License, or (at your option) any later version.
  ~
  ~ This program is distributed in the hope that it will be useful,
  ~ but WITHOUT ANY WARRANTY; without even the implied warranty of
  ~ MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  ~ GNU Affero General Public License for more details.
  ~
  ~ You should have received a copy of the GNU Affero General Public License
  ~ along with this program.  If not, see <https://www.gnu.org/licenses/>.
  -->

\<!--
  ~ Ki-Tax: System for the management of external childcare subsidies
  ~ Copyright (C) 2018 City of Bern Switzerland
  ~ This program is free software: you can redistribute it and/or modify
  ~ it under the terms of the GNU Affero General Public License as
  ~ published by the Free Software Foundation, either version 3 of the
  ~ License, or (at your option) any later version.
  ~ This program is distributed in the hope that it will be useful,
  ~ but WITHOUT ANY WARRANTY; without even the implied warranty of
  ~ MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
  ~ GNU Affero General Public License for more details.
  ~ You should have received a copy of the GNU Affero General Public License
  ~ along with this program. If not, see <http://www.gnu.org/licenses/>.
  -->

<div class="dv-benutzer adminModul">
    <form role="form" #benutzerForm (onSubmit)="saveBenutzerBerechtigungen()" novalidate>

        <fieldset>
            <div class="row">
                <div class="marginTop50 col-md-12">
                    <h1>
                        {{'BENUTZER_DETAIL' | translate: {name: selectedUser.nachname, vorname: selectedUser.vorname} }}
                    </h1>
                    <hr class="header"/>
                </div>
            </div>
            <!-- Mandant -->
            <div class="row" dv-display-element dv-display-allowed-roles="['SUPER_ADMIN']">
                <div class="col-sm-12 dv-input-container-medium">
                    <label class="md-no-float" translate for="mandant_ID">MANDANT</label>
                    <input id="mandant_ID"
                           matInput
                           type="text"
                           name="mandant"
                           [(ngModel)]="selectedUser.mandant.name"
                           class="form-control"
                           required
                           [disabled]="true">
                    <dv-ng-error-messages [errorObject]="form.mandant.$error"
                                          [inputid]="'mandant'"
                                          class="error">
                    </dv-ng-error-messages>
                </div>
            </div>
            <!-- Username -->
            <div class="row">
                <div class="col-sm-12 dv-input-container-medium">
                    <label class="md-no-float" data-translate="USERNAME" for="username_ID"></label>
                    <input id="username_ID"
                           matInput
                           type="text"
                           name="username"
                           ng-model="vm.selectedUser.username"
                           class="form-control"
                           required
                           [disabled]="true">
                    <dv-ng-error-messages [errorObject]="form.username.$error"
                                          [inputid]="'username'"
                                          [show]="form.username.touched"
                                          class="error">
                    </dv-ng-error-messages>
                </div>
            </div>
            <!-- Name / Vorname -->
            <div class="row">
                <div class="col-sm-12 dv-input-container-medium">
                    <mat-form-field class="form-group">
                        <label class="md-no-float" translate for="nachname_ID">NACHNAME</label>
                        <input id="nachname_ID"
                               matInput
                               type="text"
                               name="nachname"
                               [(ngModel)]="selectedUser.nachname"
                               class="form-control"
                               required
                               [disabled]="true">
                        <dv-ng-error-messages [errorObject]="form.nachname.$error"
                                              [inputid]="'nachname'"
                                              class="error">
                        </dv-ng-error-messages>
                    </mat-form-field>
                </div>
                <div class="col-sm-12 dv-input-container-medium">
                    <label class="md-no-float" translate for="vorname_ID">VORNAME</label>
                    <input id="vorname_ID"
                           matInput
                           type="text"
                           name="vorname"
                           [(ngModel)]="selectedUser.vorname"
                           class="form-control"
                           required
                           [disabled]="true">
                    <dv-ng-error-messages [errorObject]="form.name.$error"
                                          [inputid]="'vorname'"
                                          class="error">
                    </dv-ng-error-messages>
                </div>
            </div>
            <!-- E-Mail -->
            <div class="row">
                <div class="col-sm-12 dv-input-container-medium">
                    <label class="md-no-float" data-translate="EMAIL" for="email_ID"></label>
                    <input id="email_ID"
                           type="text"
                           name="email"
                           [(ngModel)]="selectedUser.email"
                           class="form-control"
                           required
                           [disabled]="true">
                    <dv-ng-error-messages [errorObject]="form.email.$error"
                                          [inputid]="email"
                                          class="error">
                    </dv-ng-error-messages>
                </div>
            </div>

            <!-- Warnung, wenn gesperrt -->
            <div class="row">
                <div class="col-md-12" *ngIf="selectedUser.gesperrt">
                    <div class="well well-status-warten">
                        <i class="fa fa-exclamation-triangle" aria-hidden="true"></i>
                        <span translate>BENUTZER_GESPERRT_INFO</span>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="marginTop50 col-md-12">
                    <h1 data-translate="ROLLE_AKTIV"></h1>
                    <hr class="header"/>
                </div>
            </div>

            <!-- Aktive Rolle -->
            <fieldset [disabled]="!isBerechtigungEnabled(currentBerechtigung)">
                <div class="row" [attr.disabled]="true">
                    <!-- Rolle -->
                    <div class="col-sm-12 dv-input-container-medium">
                        <div class="form-group">
                            <label class="md-no-float required dv-benutzer-label"
                                   translate
                                   for="rolle">
                                ROLLE
                            </label>
                            <div class="dv-select-style">
                                <select aria-describedby="rolle-error"
                                        name="role"
                                        id="rolle"
                                        class="form-control"
                                        [required]="true"
                                        [(ngModel)]="currentBerechtigung.role"
                                        *ngFor="let role of getRolesWithTranslations(); trackBy: trackByRole">
                                    {{role.translated}}
                                </select>
                                <dv-ng-error-messages [inputid]="rolle"
                                                      [errorObject]="form.rolle.$error"
                                                      class="error">
                                </dv-ng-error-messages>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <!-- Institution -->
                    <div class="col-sm-12 dv-input-container-medium"
                         *ngIf="isInstitutionBerechtigung(currentBerechtigung)">
                        <div class="form-group">
                            <label class="md-no-float required dv-benutzer-label"
                                   translate
                                   for="institution">INSTITUTION</label>
                            <div class="dv-select-style">
                                <select aria-describedby="institution-error" name="institution" id="institution"
                                        class="form-control"
                                        [required]="isInstitutionBerechtigung(currentBerechtigung)"
                                        [(ngModel)]="currentBerechtigung.institution.id"
                                        *ngFor="let institution of institutionenList; trackBy: trackByInstitution">
                                    {{institution.name}}
                                </select>
                                <dv-ng-error-messages [inputid]="institution"
                                                      [errorObject]="form.institution.$error"
                                                      class="error">
                                </dv-ng-error-messages>
                            </div>
                        </div>
                    </div>
                    <!-- Traegerschaft -->
                    <div class="col-sm-12 dv-input-container-medium"
                         *ngIf="isTraegerschaftBerechtigung(currentBerechtigung)">
                        <div class="form-group">
                            <label class="md-no-float required dv-benutzer-label"
                                   translate
                                   for="traegerschaft">
                                TRAEGERSCHAFT
                            </label>
                            <div class="dv-select-style">
                                <select [attr.aria-describedby]="traegerschaft-error"
                                        name="traegerschaft"
                                        id="traegerschaft"
                                        class="form-control"
                                        [required]="isTraegerschaftBerechtigung(currentBerechtigung)"
                                        [(ngModel)]="currentBerechtigung.traegerschaft.id"
                                        *ngFor="let traegerschaft of traegerschaftenList; trackBy: trackByTraegerschaft">
                                    {{traegerschaft.name}}
                                </select>
                                <dv-ng-error-messages [inputid]="traegerschaft"
                                                      [errorObject]="form.traegerschaft.$error"
                                                      class="error">
                                </dv-ng-error-messages>
                            </div>
                        </div>
                    </div>
                </div>
            </fieldset>
            <div class="row" *ngIf="!currentBerechtigung.enabled && !isDefaultVerantwortlicher">
                <div class="col-sm-12">
                    <dv-loading-button type="button"
                                       (buttonClick)="enableBerechtigung(currentBerechtigung)"
                                       button-class="dv-btn-operation">
                        <i class="fa fa-lg fa-pencil-square-o"></i>
                        <span translate>BERECHTIGUNG_AKTUELL_EDITIEREN</span>
                    </dv-loading-button>
                </div>
            </div>

            <div class="row">
                <div class="marginTop50 col-md-12">
                    <h1 translate>ROLLE_KUNEFTIG</h1>
                    <hr class="header"/>
                </div>
            </div>

            <!-- Zuk端nftige Berechtigung -->
            <div *ngIf="futureBerechtigungen?.length > 0">
                <div *ngFor="let futureBerechtigung of futureBerechtigungen; index as index">
                    <fieldset [disabled]="!isBerechtigungEnabled(futureBerechtigung)">
                        <div class="row">
                            <!-- Rolle -->
                            <div class="col-sm-12 dv-input-container-medium">
                                <div class="form-group">
                                    <label class="md-no-float required  dv-benutzer-label"
                                           translate
                                           [for]="'rolle_' + index">
                                        ROLLE
                                    </label>
                                    <div class="dv-select-style">
                                        <select [attr.aria-describedby]="rolle-error"
                                                [name]="'role_' + index"
                                                [id]="'rolle_'+ index"
                                                class="form-control"
                                                [required]="true"
                                                [(ngModel)]="futureBerechtigung.role"
                                                *ngFor="let role of getRolesWithTranslations(); trackBy: trackByRole">
                                            {{role.translated}}
                                        </select>
                                        <dv-ng-error-messages [inputid]="'rolle_' + index"
                                                              [errorObject]="form['rolle_' + index].$error"
                                                              class="error">
                                        </dv-ng-error-messages>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-12 dv-input-container-small">
                                <div class="form-group">
                                    <!--suppress XmlInvalidId -->
                                    <label class="md-no-float dv-benutzer-label"
                                           translate
                                           [for]="'roleGueltigAb_' + index">
                                        ROLLE_GUELTIG_AB
                                    </label>
                                    <dv-datepicker input-id="roleGueltigAb"
                                                   input-name="roleGueltigAb_{{$index}}"
                                                   name="roleGueltigAb_{{$index}}"
                                                   [(ngModel)]="futureBerechtigung.gueltigkeit.gueltigAb"
                                                   [required]="true"
                                                   class="input-element"
                                                   ng-attr-placeholder="{{'DATE_PLACEHOLDER' | translate}}"
                                                   dv-min-date="vm.tomorrow">
                                    </dv-datepicker>
                                    <dv-ng-error-messages [inputid]="roleGueltigAb_{{$index}}"
                                                          [errorObject]="vm.form['roleGueltigAb_' + $index].$error"
                                                          class="error">
                                    </dv-ng-error-messages>
                                </div>
                            </div>
                            <div class="col-sm-12 dv-input-container-small">
                                <div class="form-group">
                                    <!--suppress XmlInvalidId -->
                                    <label class="md-no-float dv-benutzer-label"
                                           translate
                                           for="roleGueltigBis_{{$index}}">
                                        ROLLE_GUELTIG_BIS
                                    </label>
                                    <dv-datepicker input-id="roleGueltigBis" input-name="roleGueltigBis_{{$index}}"
                                                   name="roleGueltigBis_{{$index}}"
                                                   ng-model="futureBerechtigung.gueltigkeit.gueltigBis"
                                                   class="input-element"
                                                   ng-attr-placeholder="{{'DATE_PLACEHOLDER' | translate}}"
                                                   dv-min-date="vm.tomorrow">
                                    </dv-datepicker>
                                    <dv-ng-error-messages [inputid]="roleGueltigBis_{{$index}}"
                                                          [errorObject]="form['roleGueltigBis_' + $index].$error"
                                                          class="error">
                                    </dv-ng-error-messages>
                                </div>
                                start
                            </div>
                        </div>
                        <div class="row">
                            <!-- Institution -->
                            <div class="col-sm-12 dv-input-container-medium"
                                 ng-if="isInstitutionBerechtigung(futureBerechtigung)">
                                <div class="form-group">
                                    <label class="md-no-float required dv-benutzer-label" data-translate="INSTITUTION"
                                           for="institution_{{$index}}"></label>
                                    <div class="dv-select-style">
                                        <select aria-describedby="institution-error" name="institution_{{$index}}"
                                                id="institution_{{$index}}"
                                                class="form-control"
                                                ng-required="vm.isInstitutionBerechtigung(futureBerechtigung)"
                                                ng-model="futureBerechtigung.institution.id"
                                                ng-options="institution.id as institution.name for institution in vm.institutionenList | orderBy: 'institution.name'">
                                        </select>
                                        <dv-ng-error-messages [inputid]="institution_{{$index}}"
                                                              [errorObject]="form['institution_' + $index].$error"
                                                              class="error">
                                        </dv-ng-error-messages>
                                    </div>
                                </div>
                            </div>
                            <!-- Traegerschaft -->
                            <div class="col-sm-12 dv-input-container-medium"
                                 *ngIf="isTraegerschaftBerechtigung(futureBerechtigung)">
                                <div class="form-group">
                                    <label class="md-no-float required dv-benutzer-label" data-translate="TRAEGERSCHAFT"
                                           for="traegerschaft_{{$index}}"></label>
                                    <div class="dv-select-style">
                                        <select aria-describedby="traegerschaft-error" name="traegerschaft_{{$index}}"
                                                id="traegerschaft_{{$index}}"
                                                class="form-control"
                                                [required]="isTraegerschaftBerechtigung(futureBerechtigung)"
                                                [(ngModel)]="futureBerechtigung.traegerschaft.id"
                                                ng-options="traegerschaft.id as traegerschaft.name for traegerschaft in vm.traegerschaftenList | orderBy: 'traegerschaft.name'">
                                        </select>
                                        <dv-ng-error-messages [inputid]="traegerschaft_{{$index}}"
                                                              [errorObject]="form['traegerschaft_' + $index].$error"
                                                              class="error">
                                        </dv-ng-error-messages>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </fieldset>

                    <!-- Edit Zuk端nftige Berechtigung -->
                    <div class="row" *ngIf="!futureBerechtigung.enabled  && !isDefaultVerantwortlicher">
                        <div class="col-sm-12">
                            <dv-loading-button type="button"
                                               button-click="vm.enableBerechtigung(futureBerechtigung)"
                                               button-class="dv-btn-operation">
                                <i class="fa fa-lg fa-pencil-square-o"></i>
                                <span translate>BERECHTIGUNG_KUENFTIG_EDITIEREN</span>
                            </dv-loading-button>
                        </div>
                    </div>
                    <!-- Remove Zuk端nftige Berechtigung -->
                    <div class="row" *ngIf="!isDefaultVerantwortlicher">
                        <div class="col-sm-12">
                            <dv-loading-button [type]="button"
                                               (buttonClick)="vm.removeBerechtigung(futureBerechtigung)"
                                               [buttonClass]="dv-btn-operation">
                                <i class="fa fa-lg fa-trash-o"></i>
                                <span translate>BERECHTIGUNG_ENTFERNEN</span>
                            </dv-loading-button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Add Zuk端nftige Berechtigung -->
            <div class="row" *ngIf="vm.canAddBerechtigung() && !vm.isDefaultVerantwortlicher">
                <div class="col-sm-12">
                    <dv-loading-button type="button"
                                       button-click="vm.addBerechtigung()"
                                       button-class="dv-btn-operation">
                        <i class="fa fa-lg fa-plus-circle"></i>
                        <span translate>BERECHTIGUNG_HINZUFUEGEN</span>
                    </dv-loading-button>
                </div>
            </div>

            <!-- Info, wenn Defaultbenutzer -->
            <div class="row">
                <div class="col-md-12" ng-if="vm.isDefaultVerantwortlicher">
                    <div class="well well-status-bestaetigt">
                        <i class="fa fa-exclamation-triangle" aria-hidden="true"></i>
                        <span data-translate="BENUTZER_DEFAULTVERANTWORTLICHER_INFO"></span>
                    </div>
                </div>
            </div>

            <!-- Buttons -->
            <div class="button-row dv-input-container-medium marginTop50">

                <dv-loading-button type="submit" button-class="" ng-if="!isDefaultVerantwortlicher"
                                   class="button-row-item">
                    <span data-translate="BENUTZER_SAVE"></span>
                </dv-loading-button>

                <div ng-show="!selectedUser.gesperrt" ng-if="!isDefaultVerantwortlicher" class="button-row-item">
                    <dv-loading-button type="button"
                                       button-click="vm.inactivateBenutzer()"
                                       button-class="cancel-button">
                        <span data-translate="BENUTZER_SPERREN"></span>
                    </dv-loading-button>
                </div>

                <div ng-show="vm.selectedUser.gesperrt" ng-if="!vm.isDefaultVerantwortlicher" class="button-row-item">
                    <dv-loading-button type="button"
                                       button-click="vm.reactivateBenutzer()"
                                       button-class="cancel-button">
                        <span data-translate="BENUTZER_REAKTIVIEREN"></span>
                    </dv-loading-button>
                </div>

                <div class="button-row-item">
                    <dv-loading-button type="button"
                                       button-click="vm.cancel()"
                                       button-class="cancel-button">
                        <span data-translate="CANCEL"></span>
                    </dv-loading-button>
                </div>

            </div>
        </fieldset>

        <fieldset>
            <div class="row marginTop50">
                <div class="col-md-12">
                    <h1 data-translate="BERECHTIGUNGHISTORY"></h1>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12 table-responsive">
                    <table st-table="displayedCollection" st-safe-src="vm.berechtigungHistoryList"
                           class="table" st-delay="20">
                        <thead>
                        <tr>
                            <th data-translate="BERECHTIGUNG_GEAENDERT_USER"></th>
                            <th data-translate="BERECHTIGUNG_GEAENDERT_TS"></th>
                            <th data-translate="ROLLE"></th>
                            <th data-translate="BERECHTIGUNG_GUELTIG_AB"></th>
                            <th data-translate="BERECHTIGUNG_GUELTIG_BIS"></th>
                            <th data-translate="INSTITUTIONTRAEGERSCHAFT"></th>
                            <th data-translate="GESPERRT"></th>
                            <th data-translate="GELOESCHT"></th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr ng-repeat="row in displayedCollection" st-select-row="row">
                            <td ng-bind="vm.getGeaendertDurch(row)"></td>
                            <td ng-bind="row.timestampErstellt | amDateFormat : 'DD.MM.YYYY HH:mm'"></td>
                            <td ng-bind="vm.getTranslatedRole(row.role)"></td>
                            <td ng-bind="row.gueltigkeit.gueltigAb | amDateFormat : 'DD.MM.YYYY'"></td>
                            <td ng-bind="row.gueltigkeit.gueltigBis | amDateFormat : 'DD.MM.YYYY'"></td>
                            <td ng-bind="row.getInstitutionOrTraegerschaft()"></td>
                            <td ng-bind="row.gesperrt ? 'LABEL_JA' : 'LABEL_NEIN' | translate"></td>
                            <td ng-bind="row.geloescht ? 'LABEL_JA' : 'LABEL_NEIN' | translate"></td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </fieldset>

    </form>
</div>
